events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;
    
    # Upstream for imagor
    upstream imagor_backend {
        server mrsool-imagor-staging-api.mrsool-backend-staging.svc.cluster.local:80;
        keepalive 32;
    }
    
    
    server {
        listen 80;
        server_name localhost;
        
        # Health check endpoint
        location = /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        # Main imgix to imagor conversion
        location ~* ^/(?<image_path>.+)$ {
            # Set AWS-BUCKET based on hostname
            set $aws_bucket "";
            if ($host ~ "^mrsool-data-dev-images\.mrsool\.co$") {
                set $aws_bucket "mrsool-data-dev";
            }
            if ($host ~ "^mrsool-data-2-dev-images\.mrsool\.co$") {
                set $aws_bucket "mrsool-data-2-dev";
            }
            if ($host ~ "^mrsool-data-images\.mrsool\.co$") {
                set $aws_bucket "mrsool-data";
            }
            if ($host ~ "^mrsool-data-2-images\.mrsool\.co$") {
                set $aws_bucket "mrsool-data-2";
            }
            if ($host ~ "^mrsool-images\.mrsool\.co$") {
                set $aws_bucket "mrsool-business";
            }
            # Default fallback
            if ($aws_bucket = "") {
                set $aws_bucket "mrsool-data-dev";
            }
            
            # Extract imgix parameters
            set $width $arg_w;
            set $height $arg_h;
            # Handle hyphenated parameters - nginx converts max-w to max_w in args
            set $max_width "";
            set $max_height "";
            if ($args ~ "max-w=([^&]+)") {
                set $max_width $1;
            }
            if ($args ~ "max-h=([^&]+)") {
                set $max_height $1;
            }
            set $quality $arg_q;
            set $format $arg_fm;
            set $fit $arg_fit;
            set $crop $arg_crop;
            set $auto $arg_auto;
            set $brightness $arg_bri;
            set $contrast $arg_con;
            set $saturation $arg_sat;
            set $blur $arg_blur;
            set $sharpen $arg_sharpen;
            set $greyscale $arg_greyscale;
            set $monochrome $arg_monochrome;
            
            # Initialize filters string
            set $filters '';
            # default to proportion 85, if no dimensions are provided
            set $has_dimensions "false";
            if ($max_width != "") {
                set $width $max_width;
            }
            if ($max_height != "") {
                set $height $max_height;
            }
            if ($width = "") {
                set $width "0";
            }
            if ($height = "") {
                set $height "0";
            }
            if ($height != "0") {
                set $has_dimensions "true";
            }
            if ($width != "0") {
                set $has_dimensions "true";
            }
            if ($has_dimensions = "false") {
                set $add_proportion "true";
            }
            
            # Round float dimensions to integers (Imagor doesn't support float dimensions)
            # Extract integer part from float values
            if ($width ~ "^([0-9]+)\.") {
                set $width $1;
            }
            if ($height ~ "^([0-9]+)\.") {
                set $height $1;
            }
            
            # Handle fit parameter (imgix fit modes to imagor)
            # by default, clip is true
            set $use_fit_in "true";
            set $use_max_dim "false";
            if ($max_width != "") {
                set $use_max_dim "true";
                set $use_fit_in "none";
            }
            if ($max_height != "") {
                set $use_max_dim "true";
                set $use_fit_in "none";
            }
            if ($fit = "crop") {
                set $use_fit_in "false";
            }
            if ($fit = "clip") {
                set $use_fit_in "true";
            }
            if ($fit = "fill") {
                set $filters "${filters}filters:fill(white)";
                set $use_fit_in "false";
            }
            if ($fit = "clamp") {
                set $filters "${filters}filters:no_upscale()";
                set $use_fit_in "false";
            }
                        
            # Handle quality/compression
            set $quality_int $quality;
            if ($quality_int ~ "^([0-9]+)\.") {
                set $quality_int $1;
            }
            if ($quality != "") {
                set $filters "${filters}filters:quality(${quality_int})";
            }
            if ($quality = "") {
                set $filters "${filters}filters:quality(40)";
            }
            if ($auto = "compress") {
                set $filters "${filters}filters:quality(80)";
            }
            
            # Handle format conversion
            if ($format = "webp") {
                set $filters "${filters}filters:format(webp)";
            }
            if ($format = "png") {
                set $filters "${filters}filters:format(png)";
            }
            if ($format = "jpg") {
                set $filters "${filters}filters:format(jpeg)";
            }
            if ($format = "jpeg") {
                set $filters "${filters}filters:format(jpeg)";
            }
            
            # Handle auto parameter
            if ($auto = "format") {
                set $filters "${filters}filters:format(webp)";
            }
            
            # Handle brightness
            if ($brightness != "") {
                set $filters "${filters}filters:brightness(${brightness})";
            }
            
            # Handle contrast
            if ($contrast != "") {
                set $filters "${filters}filters:contrast(${contrast})";
            }
            
            # Handle saturation
            if ($saturation != "") {
                set $filters "${filters}filters:saturation(${saturation})";
            }
            
            # Handle blur
            if ($blur != "") {
                set $filters "${filters}filters:blur(${blur})";
            }
            
            # Handle sharpen
            if ($sharpen != "") {
                set $filters "${filters}filters:sharpen(${sharpen})";
            }
            
            # Handle monochrome - apply greyscale for all monochrome values
            if ($monochrome != "") {
                set $filters "${filters}filters:grayscale()";
            }
            
            # Construct imagor URL
            set $imagor_url "/unsafe";
            if ($use_max_dim = "true") {
                set $imagor_url "${imagor_url}/max-dim";
            }
            if ($use_fit_in = "true") {
                set $imagor_url "${imagor_url}/fit-in";
            }
            set $imagor_url "${imagor_url}/${width}x${height}";
            if ($use_fit_in != "none") {
                set $filters "${filters}filters:upscale()";
            }
            if ($add_proportion = "true") {
                set $filters "${filters}filters:proportion(85)";
            }
            if ($filters != "") {
                set $imagor_url "${imagor_url}/${filters}";
            }
            set $imagor_url "${imagor_url}/${image_path}";
            
            
            # Proxy to imagor
            proxy_pass http://imagor_backend$imagor_url;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header AWS-BUCKET $aws_bucket;
            
            # Proxy timeout settings - Increased for large PNG processing
            proxy_connect_timeout 10s;
            proxy_send_timeout 150s;
            proxy_read_timeout 150s;
        }
        
        # Fallback for non-image requests
        location / {
            return 404 "Not found";
        }
    }
}
